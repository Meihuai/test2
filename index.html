import React, { useState, useMemo, useEffect } from 'react';
import { 
  Sparkles, ArrowRight, Activity, Zap, Heart, Brain, Target, 
  RefreshCw, CheckCircle, HelpCircle, Briefcase, Users, Star, 
  MapPin, Coffee, Shield, Share2, Download, Link as LinkIcon, Printer
} from 'lucide-react';

// --- 1. æ ¸å¿ƒæ•°æ®ç»“æ„ä¸æ‰©å±•ç»´åº¦å®šä¹‰ ---

const DIMENSIONS = {
  EXECUTION: { 
    id: 'EXECUTION', 
    name: 'è¡ŒåŠ¨æ‰§è¡ŒåŠ›', 
    shortName: 'æ‰§è¡Œ',
    color: '#3b82f6', 
    desc: 'å°†æƒ³æ³•è½åœ°ã€å¹¶åœ¨æˆªæ­¢æ—¥æœŸå‰äº¤ä»˜ç»“æœçš„èƒ½åŠ›ã€‚',
    traits: ['åŠ¡å®', 'å®ˆä¿¡', 'é«˜æ•ˆ'],
    careers: ['é¡¹ç›®ç»ç†', 'å¤–ç§‘åŒ»ç”Ÿ', 'è¿è¥æ€»ç›‘', 'è´¢åŠ¡å®¡è®¡', 'å…¨æ ˆå·¥ç¨‹å¸ˆ'],
    partnerMatch: 'ä½ éœ€è¦ä¸€ä¸ªæ‹¥æœ‰â€œå®è§‚è§†é‡â€çš„æ­æ¡£ï¼ˆå¦‚æˆ˜ç•¥å‹ï¼‰ï¼Œä»–ä»¬è´Ÿè´£ç”»é¥¼ï¼Œä½ è´Ÿè´£åšé¥¼ï¼Œå¤©ä½œä¹‹åˆã€‚',
    highAdvice: 'ä½ æ˜¯ä¸€å°é«˜æ•ˆçš„å¼•æ“ã€‚ä½†è¦æ³¨æ„ä¸è¦ä¸ºäº†â€œåšå®Œâ€è€Œå¿½ç•¥äº†â€œä¸ºä»€ä¹ˆè¦åšâ€ã€‚å°è¯•å¤šé—®ä¸€ä¸ªWhyã€‚'
  },
  COMMUNICATION: { 
    id: 'COMMUNICATION', 
    name: 'å…±æƒ…æ²Ÿé€šåŠ›', 
    shortName: 'æ²Ÿé€š',
    color: '#ec4899', 
    desc: 'æ„ŸçŸ¥ä»–äººæƒ…ç»ªã€æ¸…æ™°è¡¨è¾¾å¹¶å»ºç«‹è¿æ¥çš„èƒ½åŠ›ã€‚',
    traits: ['æ¸©æš–', 'å€¾å¬', 'åè°ƒ'],
    careers: ['äººåŠ›èµ„æºBP', 'å¿ƒç†å’¨è¯¢å¸ˆ', 'å…¬å…³ç»ç†', 'ç”¨æˆ·ä½“éªŒç ”ç©¶å‘˜', 'é”€å”®æ€»ç›‘'],
    partnerMatch: 'ä½ é€‚åˆä¸â€œé€»è¾‘ç¼œå¯†â€æˆ–â€œæƒ…ç»ªç¨³å®šâ€çš„äººç›¸å¤„ï¼ˆå¦‚æŠ—å‹å‹ï¼‰ï¼Œä»–ä»¬èƒ½ç»™ä½ æä¾›ç†æ€§çš„é”šç‚¹ã€‚',
    highAdvice: 'ä½ çš„æ„ŸæŸ“åŠ›æ˜¯å¤©èµ‹ã€‚åœ¨å›¢é˜Ÿäº‰æ‰§æ—¶ï¼Œä¸è¦åªåšå’Œäº‹ä½¬ï¼Œå°è¯•å¼•å¯¼å¤§å®¶æŠŠæƒ…ç»ªè½¬åŒ–ä¸ºå»ºè®¾æ€§çš„æ–¹æ¡ˆã€‚'
  },
  INNOVATION: { 
    id: 'INNOVATION', 
    name: 'åˆ›æ–°æ€ç»´åŠ›', 
    shortName: 'åˆ›æ–°',
    color: '#8b5cf6', 
    desc: 'æ‰“ç ´å¸¸è§„ã€æ¢ç´¢æ–°æ–¹æ³•å’Œæ–°å¯èƒ½æ€§çš„èƒ½åŠ›ã€‚',
    traits: ['å¥½å¥‡', 'çµæ´»', 'è„‘æ´'],
    careers: ['äº§å“ç»ç†', 'å¹¿å‘Šåˆ›æ„æ€»ç›‘', 'åˆ›ä¸šè€…', 'æ¸¸æˆç­–åˆ’', 'ç§‘ç ”äººå‘˜'],
    partnerMatch: 'æœ€é€‚åˆä½ çš„æœ‹å‹æ˜¯â€œè¶…å¼ºæ‰§è¡ŒåŠ›â€çš„äººã€‚ä½ è´Ÿè´£å¤©é©¬è¡Œç©ºï¼Œä»–è´Ÿè´£è„šè¸å®åœ°ï¼Œé¿å…ä½ çš„ç‚¹å­é£˜åœ¨ç©ºä¸­ã€‚',
    highAdvice: 'ç‚¹å­å¤šæ˜¯å¥½äº‹ï¼Œä½†è¦è­¦æƒ•â€œä¸‰åˆ†é’Ÿçƒ­åº¦â€ã€‚è¯•ç€é€¼è‡ªå·±æŠŠä¸€ä¸ªæœ€æ™®é€šçš„ç‚¹å­æ‰“ç£¨åˆ°æè‡´ã€‚'
  },
  RESILIENCE: { 
    id: 'RESILIENCE', 
    name: 'æŠ—å‹å¤åŸåŠ›', 
    shortName: 'æŠ—å‹',
    color: '#10b981', 
    desc: 'é¢å¯¹é€†å¢ƒã€å†²çªå’Œå¤±è´¥æ—¶ä¿æŒæƒ…ç»ªç¨³å®šçš„èƒ½åŠ›ã€‚',
    traits: ['åšéŸ§', 'å†·é™', 'ä¹è§‚'],
    careers: ['æ€¥è¯ŠåŒ»ç”Ÿ', 'å±æœºå…¬å…³', 'æŠ•èµ„äº¤æ˜“å‘˜', 'åˆ‘ä¾¦è­¦å¯Ÿ', 'å®¢æˆ·æŠ•è¯‰å¤„ç†'],
    partnerMatch: 'ä½ åƒç£çŸ³ä¸€æ ·å¯é ã€‚ä½ ä¼šæ¬£èµé‚£äº›â€œå……æ»¡æ¿€æƒ…â€æˆ–â€œæ„Ÿæ€§ç»†è…»â€çš„äººï¼ˆå¦‚æ²Ÿé€šå‹ï¼‰ï¼Œä»–ä»¬èƒ½ç‚¹äº®ä½ æœ‰æ—¶è¿‡äºå¹³æ·¡çš„ç”Ÿæ´»ã€‚',
    highAdvice: 'ä½ å¾ˆèƒ½æ‰›äº‹ï¼Œä½†åˆ«æŠŠè‡ªå·±æ†‹åäº†ã€‚é€‚å½“å±•ç¤ºè„†å¼±ï¼ˆVulnerabilityï¼‰åè€Œèƒ½å¢åŠ ä½ çš„é¢†å¯¼é­…åŠ›ã€‚'
  },
  STRATEGY: { 
    id: 'STRATEGY', 
    name: 'æˆ˜ç•¥è§„åˆ’åŠ›', 
    shortName: 'æˆ˜ç•¥',
    color: '#f59e0b', 
    desc: 'é€è¿‡ç°è±¡çœ‹æœ¬è´¨ã€åˆ¶å®šé•¿æœŸç›®æ ‡å’Œè·¯å¾„çš„èƒ½åŠ›ã€‚',
    traits: ['è¿œè§', 'é€»è¾‘', 'å¤§å±€'],
    careers: ['ç®¡ç†å’¨è¯¢å¸ˆ', 'ä¼ä¸šCEO', 'æˆ˜ç•¥åˆ†æå¸ˆ', 'æ¶æ„å¸ˆ', 'ç”µå½±å¯¼æ¼”'],
    partnerMatch: 'ä½ å®¹æ˜“è¢«â€œç»†èŠ‚æ§â€å’Œâ€œæ‰§è¡Œå¼ºâ€çš„äººå¸å¼•ã€‚ä½ æŒ‡æ–¹å‘ï¼Œä»–å¼€è·¯ï¼Œè¿™æ˜¯æœ€çœå¿ƒçš„ç»„åˆã€‚',
    highAdvice: 'å°å¿ƒé™·å…¥â€œåˆ†æç˜«ç—ªâ€ï¼ˆAnalysis Paralysisï¼‰ã€‚æœ‰æ—¶å€™ï¼Œä¸€ä¸ªåªæœ‰60%æŠŠæ¡çš„å¿«é€Ÿè¡ŒåŠ¨ï¼Œèƒœè¿‡100%å®Œç¾çš„çº¸ä¸Šè°ˆå…µã€‚'
  }
};

// --- 2. æ‰©å±•é¢˜åº“ ---

const MAIN_QUESTIONS = [
  { id: 'e1', dimension: 'EXECUTION', text: 'å³ä½¿æ²¡æœ‰äººç›‘ç£ï¼Œæˆ‘ä¹Ÿèƒ½ä¸¥æ ¼æŒ‰ç…§è‡ªå·±åˆ¶å®šçš„æ—¶é—´è¡¨å®Œæˆä»»åŠ¡ã€‚' },
  { id: 'e2', dimension: 'EXECUTION', text: 'æˆ‘éå¸¸è®¨åŒè¿Ÿåˆ°æˆ–ä»»åŠ¡å»¶æœŸï¼Œè¿™ä¼šè®©æˆ‘æ„Ÿåˆ°æåº¦ç„¦è™‘ã€‚' },
  { id: 'e3', dimension: 'EXECUTION', text: 'æ¯”èµ·â€œè®¨è®ºè¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦å®Œç¾â€ï¼Œæˆ‘æ›´å€¾å‘äºâ€œå…ˆåšå‡ºæ¥çœ‹çœ‹æ•ˆæœâ€ã€‚' },
  { id: 'e4', dimension: 'EXECUTION', text: 'æˆ‘çš„ç”µè„‘æ¡Œé¢å’Œç”Ÿæ´»ç©ºé—´é€šå¸¸æ˜¯äº•äº•æœ‰æ¡çš„ï¼Œæ‰¾ä¸œè¥¿å¾ˆå¿«ã€‚' },
  { id: 'c1', dimension: 'COMMUNICATION', text: 'åœ¨å¤šäººèšä¼šä¸­ï¼Œæˆ‘ç»å¸¸èƒ½æ³¨æ„åˆ°é‚£ä¸ªè¢«å†·è½çš„äººï¼Œå¹¶ä¸»åŠ¨æŠŠä»–æ‹‰å…¥è¯é¢˜ã€‚' },
  { id: 'c2', dimension: 'COMMUNICATION', text: 'æœ‹å‹ä»¬éƒ½è¯´æˆ‘æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å€¾å¬è€…ï¼Œæ„¿æ„å‘æˆ‘åéœ²å¿ƒå£°ã€‚' },
  { id: 'c3', dimension: 'COMMUNICATION', text: 'ä¸ºäº†ç»´æŠ¤å…³ç³»çš„å’Œè°ï¼Œæˆ‘æœ‰æ—¶æ„¿æ„åœ¨éåŸåˆ™é—®é¢˜ä¸Šåšå‡ºå¦¥åã€‚' },
  { id: 'c4', dimension: 'COMMUNICATION', text: 'æˆ‘èƒ½æ•é”åœ°å¯Ÿè§‰åˆ°å¹¶åœ¨æ„åˆ«äººçš„è¨€å¤–ä¹‹æ„æˆ–å¾®è¡¨æƒ…ã€‚' },
  { id: 'i1', dimension: 'INNOVATION', text: 'æˆ‘ç»å¸¸ä¼šæœ‰ä¸€äº›è¢«åˆ«äººè®¤ä¸ºæ˜¯â€œå¼‚æƒ³å¤©å¼€â€æˆ–â€œä¸åˆ‡å®é™…â€çš„æƒ³æ³•ã€‚' },
  { id: 'i2', dimension: 'INNOVATION', text: 'é‡å¤åšåŒæ ·çš„å·¥ä½œä¼šè®©æˆ‘æ„Ÿåˆ°æåº¦åŒçƒ¦ï¼Œæˆ‘æ€»æƒ³å˜ç‚¹èŠ±æ ·ã€‚' },
  { id: 'i3', dimension: 'INNOVATION', text: 'æˆ‘å¯¹æœªçŸ¥çš„æ–°äº‹ç‰©ï¼ˆå¦‚æ–°æŠ€æœ¯ã€æ–°è‰ºæœ¯ï¼‰æ€»æ˜¯ä¿æŒç€å¼ºçƒˆçš„å¥½å¥‡å¿ƒã€‚' },
  { id: 'i4', dimension: 'INNOVATION', text: 'è§£å†³é—®é¢˜æ—¶ï¼Œæˆ‘ç»å¸¸è·³å‡ºè§„åˆ™æ¡†æ¶ï¼Œå¯»æ‰¾æ·å¾„æˆ–éä¼ ç»Ÿçš„æ–¹æ³•ã€‚' },
  { id: 'r1', dimension: 'RESILIENCE', text: 'å½“çªå‘æ„å¤–æ‰“ä¹±æˆ‘çš„å…¨ç›˜è®¡åˆ’æ—¶ï¼Œæˆ‘èƒ½å¾ˆå¿«å†·é™ä¸‹æ¥å¯»æ‰¾è¡¥æ•‘æªæ–½ã€‚' },
  { id: 'r2', dimension: 'RESILIENCE', text: 'é¢å¯¹ä¸¥å‰çš„è´Ÿé¢åé¦ˆæˆ–æ‰¹è¯„ï¼Œæˆ‘å¾ˆå°‘æ„Ÿåˆ°è‡ªæˆ‘æ€€ç–‘ï¼Œè€Œæ˜¯ä¸“æ³¨äºæ”¹è¿›ã€‚' },
  { id: 'r3', dimension: 'RESILIENCE', text: 'åœ¨å·¨å¤§çš„å‹åŠ›ä¸‹ï¼ˆå¦‚Deadlineä¸´è¿‘ï¼‰ï¼Œæˆ‘çš„å·¥ä½œæ•ˆç‡åè€Œå¯èƒ½æ›´é«˜ã€‚' },
  { id: 'r4', dimension: 'RESILIENCE', text: 'æˆ‘å¾ˆå°‘åœ¨æ·±å¤œå› ä¸ºç™½å¤©å‘ç”Ÿçš„ä¸æ„‰å¿«è€Œè¾—è½¬åä¾§ç¡ä¸ç€è§‰ã€‚' },
  { id: 's1', dimension: 'STRATEGY', text: 'åšå†³å®šå‰ï¼Œæˆ‘ä¼šèŠ±æ—¶é—´æ¨æ¼”å„ç§å¯èƒ½çš„ç»“æœå’Œåˆ†æ”¯è·¯å¾„ã€‚' },
  { id: 's2', dimension: 'STRATEGY', text: 'æˆ‘æ¸…æ¥šåœ°çŸ¥é“è‡ªå·±3-5å¹´åæƒ³æˆä¸ºä»€ä¹ˆæ ·çš„äººï¼Œå¹¶æ­£åœ¨ä¸ºæ­¤å¸ƒå±€ã€‚' },
  { id: 's3', dimension: 'STRATEGY', text: 'åœ¨å›¢é˜Ÿè®¨è®ºä¸­ï¼Œæˆ‘ç»å¸¸æŠŠå¤§å®¶ä»â€œç»†èŠ‚äº‰è®ºâ€æ‹‰å›åˆ°â€œåŸæœ¬çš„ç›®æ ‡â€ä¸Šæ¥ã€‚' },
  { id: 's4', dimension: 'STRATEGY', text: 'æˆ‘å–œæ¬¢ç©ç­–ç•¥ç±»æ¸¸æˆï¼ˆå¦‚æ£‹ç±»ã€æ¨¡æ‹Ÿç»è¥ï¼‰ï¼Œäº«å—å¸ƒå±€è·èƒœçš„å¿«æ„Ÿã€‚' }
];

const BACKUP_QUESTIONS = {
  EXECUTION: [
    { text: 'æˆ‘ç»å¸¸åˆ—To-Do Listï¼Œä½†çœŸæ­£å®Œæˆçš„å¾€å¾€ä¸åˆ°ä¸€åŠã€‚ï¼ˆåå‘ï¼‰', isReverse: true },
    { text: 'ç­”åº”åˆ«äººçš„äº‹ï¼Œå“ªæ€•é€šå®µæˆ‘ä¹Ÿè¦å®Œæˆã€‚' }
  ],
  COMMUNICATION: [
    { text: 'æˆ‘ç»å¸¸å› ä¸ºè¯´è¯å¤ªç›´è€Œæ— æ„ä¸­å¾—ç½ªäººã€‚ï¼ˆåå‘ï¼‰', isReverse: true },
    { text: 'æˆ‘æ“…é•¿ç”¨å¯¹æ–¹å¬å¾—æ‡‚çš„è¯­è¨€å»è§£é‡Šå¤æ‚çš„äº‹æƒ…ã€‚' }
  ],
  INNOVATION: [
    { text: 'æˆ‘å€¾å‘äºä½¿ç”¨è€åŠæ³•è§£å†³é—®é¢˜ï¼Œå› ä¸ºé‚£æ ·æ›´ç¨³å¦¥ã€‚ï¼ˆåå‘ï¼‰', isReverse: true },
    { text: 'æˆ‘ç»å¸¸ä¼šé—®â€œä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿæœ‰æ²¡æœ‰æ›´å¥½çš„åŠæ³•ï¼Ÿâ€' }
  ],
  RESILIENCE: [
    { text: 'ä¸€æ¬¡å¤±è´¥çš„ç»å†ä¼šè®©æˆ‘æ²®ä¸§å¾ˆä¹…ï¼Œç”šè‡³ä¸æ•¢å†æ¬¡å°è¯•ã€‚ï¼ˆåå‘ï¼‰', isReverse: true },
    { text: 'æˆ‘èƒ½å¾ˆå¥½åœ°åˆ†ç¦»â€œå·¥ä½œä¸­çš„æˆ‘â€å’Œâ€œç”Ÿæ´»ä¸­çš„æˆ‘â€ï¼Œæƒ…ç»ªä¸å¸¦å›å®¶ã€‚' }
  ],
  STRATEGY: [
    { text: 'æˆ‘åšäº‹æ¯”è¾ƒéšæ€§ï¼Œèµ°åˆ°å“ªç®—å“ªï¼Œä¸å¤ªå–œæ¬¢åšé•¿è¿œè®¡åˆ’ã€‚ï¼ˆåå‘ï¼‰', isReverse: true },
    { text: 'æˆ‘èƒ½ä»çº·ç¹å¤æ‚çš„ä¿¡æ¯ä¸­å¿«é€ŸæŠ“å‡ºæ ¸å¿ƒé€»è¾‘ã€‚' }
  ]
};

// --- 3. è‡ªå®šä¹‰é›·è¾¾å›¾ç»„ä»¶ (SVG) ---

const RadarChart = ({ data, size = 300 }) => {
  const center = size / 2;
  const radius = (size / 2) - 40; 
  const totalAxes = data.length;
  const angleSlice = (Math.PI * 2) / totalAxes;

  const getCoordinates = (value, index, maxVal = 100) => {
    const angle = index * angleSlice - Math.PI / 2; 
    const r = (value / maxVal) * radius;
    return {
      x: center + r * Math.cos(angle),
      y: center + r * Math.sin(angle)
    };
  };

  const levels = [20, 40, 60, 80, 100];
  const pathPoints = data.map((d, i) => {
    const coords = getCoordinates(d.score, i);
    return `${coords.x},${coords.y}`;
  }).join(' ');

  return (
    <svg width={size} height={size} className="mx-auto overflow-visible">
      {levels.map((level, i) => (
        <g key={i}>
          <polygon
            points={data.map((_, idx) => {
              const c = getCoordinates(level, idx);
              return `${c.x},${c.y}`;
            }).join(' ')}
            fill="none"
            stroke="#e5e7eb"
            strokeWidth="1"
          />
        </g>
      ))}
      {data.map((d, i) => {
        const endPoint = getCoordinates(100, i);
        const labelPoint = getCoordinates(115, i); 
        return (
          <g key={i}>
            <line x1={center} y1={center} x2={endPoint.x} y2={endPoint.y} stroke="#e5e7eb" strokeWidth="1" />
            <text 
              x={labelPoint.x} 
              y={labelPoint.y} 
              textAnchor="middle" 
              dominantBaseline="middle"
              className="text-xs font-bold fill-gray-600"
            >
              {d.name}
            </text>
          </g>
        );
      })}
      <polygon points={pathPoints} fill="rgba(99, 102, 241, 0.4)" stroke="#4f46e5" strokeWidth="2" />
      {data.map((d, i) => {
        const coords = getCoordinates(d.score, i);
        return (
          <circle key={i} cx={coords.x} cy={coords.y} r="4" fill="#4f46e5" className="hover:r-6 transition-all" />
        );
      })}
    </svg>
  );
};

// --- 4. ä¸»åº”ç”¨ç¨‹åº ---

export default function CompetencyProfilePro() {
  const [gameState, setGameState] = useState('intro'); 
  const [questionQueue, setQuestionQueue] = useState([]);
  const [currentQIndex, setCurrentQIndex] = useState(0);
  const [scores, setScores] = useState({}); 
  const [isSharedView, setIsSharedView] = useState(false);
  const [copyStatus, setCopyStatus] = useState('idle'); // idle, copied

  // --- åˆå§‹åŒ–ä¸URLå‚æ•°æ£€æŸ¥ ---
  useEffect(() => {
    // æ£€æŸ¥ URL æ˜¯å¦åŒ…å«åˆ†äº«çš„ç»“æœæ•°æ®
    const params = new URLSearchParams(window.location.search);
    const sharedData = params.get('r');

    if (sharedData) {
      try {
        // è§£ç  Base64 å¹¶è§£æ JSON
        const decodedScores = JSON.parse(atob(sharedData));
        setScores(decodedScores);
        setGameState('result');
        setIsSharedView(true);
      } catch (e) {
        console.error("Failed to parse shared result", e);
        // å¦‚æœè§£æå¤±è´¥ï¼Œæ­£å¸¸è¿›å…¥é¦–é¡µ
      }
    }
  }, []);

  const shuffleArray = (array) => {
    const newArr = [...array];
    for (let i = newArr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
    }
    return newArr;
  };

  const startTest = () => {
    setQuestionQueue(shuffleArray(MAIN_QUESTIONS));
    setScores({
      EXECUTION: { total: 0, count: 0 },
      COMMUNICATION: { total: 0, count: 0 },
      INNOVATION: { total: 0, count: 0 },
      RESILIENCE: { total: 0, count: 0 },
      STRATEGY: { total: 0, count: 0 },
    });
    setCurrentQIndex(0);
    setGameState('test');
    setIsSharedView(false);
    
    // æ¸…é™¤ URL å‚æ•°ï¼Œé¿å…åˆ·æ–°ååˆå›åˆ°åˆ†äº«é¡µ
    window.history.replaceState({}, document.title, window.location.pathname);
  };

  const handleAnswer = (value) => {
    const currentQ = questionQueue[currentQIndex];
    let score = value;
    if (currentQ.isReverse && score > 0) score = 6 - score; 

    const newScores = { ...scores };
    if (score > 0) {
      newScores[currentQ.dimension].total += score;
      newScores[currentQ.dimension].count += 1;
    }
    setScores(newScores);

    let nextQueue = [...questionQueue];
    if (value === 0 || value === 3) {
      const dim = currentQ.dimension;
      const backups = BACKUP_QUESTIONS[dim];
      const usedBackups = questionQueue.filter(q => q.dimension === dim && q.isBackup).length;
      if (backups && usedBackups < backups.length) {
        const nextBackup = { ...backups[usedBackups], id: `bk-${Date.now()}`, dimension: dim, isBackup: true };
        nextQueue.splice(currentQIndex + 1, 0, nextBackup);
      }
    }
    
    setQuestionQueue(nextQueue);

    if (currentQIndex < nextQueue.length - 1) {
      setCurrentQIndex(currentQIndex + 1);
    } else {
      setGameState('analyzing');
      setTimeout(() => setGameState('result'), 2000);
    }
  };

  const results = useMemo(() => {
    if (gameState !== 'result') return null;
    
    const calculated = Object.keys(DIMENSIONS).map(key => {
      const s = scores[key] || { total: 0, count: 0 }; // å®‰å…¨è®¿é—®
      const avg = s.count > 0 ? (s.total / s.count) : 3;
      const percentage = Math.round((avg / 5) * 100);
      return {
        key,
        ...DIMENSIONS[key],
        rawScore: avg,
        score: percentage 
      };
    });

    const sorted = [...calculated].sort((a, b) => b.score - a.score);
    const top3 = sorted.slice(0, 3);
    
    const top2Keys = [top3[0].id, top3[1].id].sort().join('_');
    let personaTitle = "å…¨èƒ½æ½œåŠ›è€…";
    if (top3[0].id === 'INNOVATION' && top3[1].id === 'EXECUTION') personaTitle = "åŠ¡å®çš„æ¢¦æƒ³å®¶";
    else if (top3[0].id === 'STRATEGY' && top3[1].id === 'EXECUTION') personaTitle = "æˆ˜ç•¥æ¨è¿›è€…";
    else if (top3[0].id === 'COMMUNICATION' && top3[1].id === 'RESILIENCE') personaTitle = "æ¸©æƒ…çš„å®ˆæŠ¤è€…";
    else if (top3[0].id === 'RESILIENCE' && top3[1].id === 'STRATEGY') personaTitle = "å†·é™çš„æ£‹æ‰‹";
    else if (top3[0].id === 'INNOVATION' && top3[1].id === 'COMMUNICATION') personaTitle = "é­…åŠ›å¸ƒé“å¸ˆ";
    else personaTitle = `${top3[0].traits[0]}ä¸”${top3[1].traits[0]}çš„${top3[0].name.slice(-3)}`;

    return { all: calculated, sorted, top3, personaTitle };
  }, [scores, gameState]);

  // --- åˆ†äº«ä¸ä¿å­˜åŠŸèƒ½ ---

  const generateShareLink = () => {
    // å°† scores å¯¹è±¡åºåˆ—åŒ–å¹¶è½¬ä¸º Base64 å­—ç¬¦ä¸²
    const jsonStr = JSON.stringify(scores);
    const encoded = btoa(jsonStr);
    const url = `${window.location.origin}${window.location.pathname}?r=${encoded}`;
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    const copyToClipboard = () => {
        // ä½¿ç”¨ä¼ ç»Ÿçš„ execCommand ä½œä¸ºåå¤‡æ–¹æ¡ˆï¼Œä»¥ç¡®ä¿ iframe å…¼å®¹æ€§
        const textArea = document.createElement("textarea");
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            setCopyStatus('copied');
            setTimeout(() => setCopyStatus('idle'), 2000);
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }
        document.body.removeChild(textArea);
    };
    
    copyToClipboard();
  };

  const handlePrint = () => {
    window.print();
  };

  // --- Render Views ---

  if (gameState === 'intro') {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 font-sans">
        <div className="max-w-2xl w-full bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100">
          <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-10 text-white text-center relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
            <Sparkles className="w-20 h-20 mx-auto mb-6 text-yellow-300 animate-pulse" />
            <h1 className="text-4xl font-extrabold mb-4 tracking-tight">å…¨ç»´èƒœä»»åŠ›ç”»åƒ</h1>
            <p className="text-blue-100 text-lg max-w-lg mx-auto leading-relaxed">
              åœ¨è¿™ä¸ªä¸ç¡®å®šçš„ä¸–ç•Œé‡Œï¼Œçœ‹æ¸…è‡ªå·±çš„å…‰èŠ’æ¯”ä»€ä¹ˆéƒ½é‡è¦ã€‚5ä¸ªç»´åº¦ï¼Œ20é“æ·±åº¦æƒ…å¢ƒé¢˜ï¼Œå‘ç°ä½ çš„æ ¸å¿ƒç«äº‰åŠ›ã€‚
            </p>
          </div>
          <div className="p-10 space-y-8">
            <button 
              onClick={startTest}
              className="w-full bg-slate-900 hover:bg-blue-600 text-white text-lg font-bold py-5 rounded-2xl transition-all shadow-xl hover:shadow-2xl flex items-center justify-center gap-3 group"
            >
              å¼€å¯æ¢ç´¢ä¹‹æ—… <ArrowRight className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
            </button>
            <p className="text-center text-xs text-gray-400">åŒ¿åæµ‹è¯• Â· å¯ç”ŸæˆæŠ¥å‘Šé“¾æ¥</p>
          </div>
        </div>
      </div>
    );
  }

  if (gameState === 'test') {
    const currentQ = questionQueue[currentQIndex];
    const progress = Math.round(((currentQIndex) / questionQueue.length) * 100);

    return (
      <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4">
        <div className="max-w-xl w-full">
          <div className="flex justify-between text-xs text-gray-500 mb-2 font-medium">
            <span>æ¢ç´¢è¿›åº¦</span>
            <span>{progress}%</span>
          </div>
          <div className="h-2 bg-gray-200 rounded-full overflow-hidden mb-8">
            <div 
              className="h-full bg-blue-600 transition-all duration-500 ease-out"
              style={{ width: `${progress}%` }}
            ></div>
          </div>
          <div className="bg-white rounded-3xl shadow-xl p-8 md:p-10 relative transition-all duration-300">
            {currentQ.isBackup && (
              <div className="absolute top-0 right-0 bg-orange-50 text-orange-600 px-4 py-1 rounded-bl-xl rounded-tr-xl text-xs font-bold border-l border-b border-orange-100 flex items-center gap-1">
                <RefreshCw className="w-3 h-3" /> æ·±åº¦ç¡®è®¤ä¸­
              </div>
            )}
            <div className="min-h-[120px] flex items-center justify-center mb-8">
              <h2 className="text-xl md:text-2xl font-medium text-slate-800 text-center leading-relaxed">
                {currentQ.text}
              </h2>
            </div>
            <div className="space-y-3">
              {[
                { val: 5, label: 'éå¸¸ç¬¦åˆ' },
                { val: 4, label: 'æ¯”è¾ƒç¬¦åˆ' },
                { val: 3, label: 'ä¸€èˆ¬ / è§†æƒ…å†µè€Œå®š' },
                { val: 2, label: 'ä¸å¤ªç¬¦åˆ' },
                { val: 1, label: 'å®Œå…¨ä¸ç¬¦' },
              ].map((opt) => (
                <button 
                  key={opt.val}
                  onClick={() => handleAnswer(opt.val)} 
                  className={`w-full py-4 px-6 rounded-xl border-2 border-slate-100 text-left transition-all text-slate-600 font-medium hover:border-blue-500 hover:bg-blue-50 hover:text-blue-700`}
                >
                  {opt.label}
                </button>
              ))}
              <button onClick={() => handleAnswer(0)} className="w-full py-3 text-center text-sm text-gray-400 hover:text-blue-500 mt-2">
                è·³è¿‡ / ä¸ç¡®å®š
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (gameState === 'analyzing') {
    return (
      <div className="min-h-screen bg-blue-600 flex flex-col items-center justify-center text-white p-4">
        <Activity className="w-16 h-16 animate-bounce" />
        <h2 className="text-3xl font-bold mt-8">æ­£åœ¨ç”Ÿæˆå…¨æ¯ç”»åƒ...</h2>
      </div>
    );
  }

  const { all, sorted, top3, personaTitle } = results;

  return (
    <div className="min-h-screen bg-slate-50 font-sans pb-12 print:bg-white print:p-0">
      
      {/* é¡¶éƒ¨æç¤ºæ  (ä»…åœ¨åˆ†äº«è§†å›¾æ˜¾ç¤º) */}
      {isSharedView && (
        <div className="bg-yellow-50 text-yellow-800 px-4 py-3 text-center text-sm font-medium print:hidden">
          ğŸ‘€ æ‚¨æ­£åœ¨æŸ¥çœ‹åˆ«äººåˆ†äº«çš„èƒœä»»åŠ›ç”»åƒã€‚
          <button onClick={startTest} className="underline ml-2 hover:text-yellow-900">
            æˆ‘ä¹Ÿè¦æµ‹
          </button>
        </div>
      )}

      {/* 1. Header Area with Persona */}
      <div className="bg-slate-900 text-white pt-12 pb-20 px-4 rounded-b-[3rem] shadow-2xl relative overflow-hidden print:shadow-none print:rounded-none print:pt-4 print:pb-8">
        <div className="absolute top-0 right-0 opacity-10 transform translate-x-1/4 -translate-y-1/4 print:hidden">
          <Star className="w-96 h-96" />
        </div>
        <div className="max-w-4xl mx-auto text-center relative z-10">
          <div className="inline-block bg-white/10 backdrop-blur-md px-4 py-1 rounded-full text-sm font-medium text-yellow-300 mb-4 border border-white/10 print:text-black print:border-black">
            èƒœä»»åŠ›åˆ†ææŠ¥å‘Š
          </div>
          <h1 className="text-4xl md:text-5xl font-bold mb-2 tracking-tight print:text-black">
            {personaTitle}
          </h1>
          <div className="mt-8 flex justify-center gap-4 flex-wrap">
            {top3.map((item, idx) => (
              <div key={item.id} className="bg-white/10 border border-white/20 px-4 py-2 rounded-lg flex items-center gap-2 print:border-black print:text-black">
                <span className="text-xl font-bold">{idx + 1}</span>
                <span className="text-sm opacity-90">{item.name}</span>
              </div>
            ))}
          </div>
        </div>
      </div>

      <div className="max-w-4xl mx-auto px-4 -mt-16 relative z-20 space-y-8 print:mt-4">
        
        {/* 2. Radar Chart Card */}
        <div className="bg-white rounded-3xl shadow-lg p-6 md:p-8 flex flex-col md:flex-row items-center gap-8 print:shadow-none print:border print:border-gray-200">
          <div className="w-full md:w-1/2 flex justify-center">
            <RadarChart 
              data={all.map(d => ({ name: d.shortName, score: d.score }))} 
              size={320} 
            />
          </div>
          <div className="w-full md:w-1/2 space-y-6">
            <h3 className="text-xl font-bold flex items-center gap-2 text-slate-800">
              <Activity className="w-5 h-5 text-blue-500" /> ç»´åº¦å¾—åˆ†
            </h3>
            <div className="space-y-4">
              {sorted.map(item => (
                <div key={item.id}>
                  <div className="flex justify-between text-sm mb-1">
                    <span className="font-medium text-slate-700">{item.name}</span>
                    <span className="font-bold text-slate-900">{item.score}åˆ†</span>
                  </div>
                  <div className="h-2 bg-slate-100 rounded-full overflow-hidden print:border print:border-gray-200">
                    <div 
                      className="h-full rounded-full print:bg-black" 
                      style={{ width: `${item.score}%`, backgroundColor: item.color }}
                    ></div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* 3. Top Strengths Deep Dive */}
        <div className="grid md:grid-cols-3 gap-4 print:block print:space-y-4">
          {top3.map((item, idx) => (
            <div key={item.id} className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 print:break-inside-avoid print:border-gray-300">
              <div className="flex items-center justify-between mb-4">
                <div className="text-xs font-bold px-2 py-1 rounded bg-slate-100 text-slate-600">
                  TOP {idx + 1}
                </div>
                <div style={{ color: item.color }} className="print:text-black">
                   {/* Icons (Simplified for brevity) */}
                   <Star className="w-6 h-6"/>
                </div>
              </div>
              <h3 className="text-lg font-bold mb-2 text-slate-800">{item.name}</h3>
              <p className="text-sm text-slate-500 mb-4 h-10 print:h-auto">{item.desc}</p>
              <div className="pt-4 border-t border-slate-50">
                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">å¦‚ä½•æ‰¬é•¿</h4>
                <p className="text-sm text-slate-700">{item.highAdvice}</p>
              </div>
            </div>
          ))}
        </div>

        {/* 4. Career & Social */}
        <div className="grid md:grid-cols-2 gap-6 print:block print:space-y-6">
          <div className="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-3xl p-8 border border-blue-100 print:bg-white print:border-gray-300 print:break-inside-avoid">
             <div className="flex items-center gap-3 mb-6">
               <Briefcase className="w-6 h-6 text-blue-600 print:text-black" />
               <h3 className="text-xl font-bold text-slate-800">èŒåœºå®šä½</h3>
             </div>
             <div className="flex flex-wrap gap-2 mb-6">
               {[...top3[0].careers, ...top3[1].careers].slice(0, 6).map(career => (
                 <span key={career} className="bg-white px-3 py-1.5 rounded-lg text-sm font-medium text-blue-700 shadow-sm border border-blue-100 print:border-black print:text-black">
                   {career}
                 </span>
               ))}
             </div>
          </div>

          <div className="bg-gradient-to-br from-pink-50 to-rose-50 rounded-3xl p-8 border border-pink-100 print:bg-white print:border-gray-300 print:break-inside-avoid">
             <div className="flex items-center gap-3 mb-6">
               <Heart className="w-6 h-6 text-rose-600 print:text-black" />
               <h3 className="text-xl font-bold text-slate-800">ç¤¾äº¤ä¸ä¼´ä¾£</h3>
             </div>
             <p className="text-slate-700 text-sm leading-relaxed bg-white/60 p-3 rounded-xl print:bg-transparent print:p-0">
               {top3[0].partnerMatch}
             </p>
          </div>
        </div>

        {/* 5. Action Bar (Print/Share) */}
        <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 flex items-center gap-3 bg-white/90 backdrop-blur-md p-2 rounded-full shadow-2xl border border-slate-200 print:hidden z-50">
          <button 
            onClick={generateShareLink}
            className={`flex items-center gap-2 px-5 py-3 rounded-full font-bold transition-all ${
              copyStatus === 'copied' 
                ? 'bg-green-500 text-white' 
                : 'bg-slate-900 text-white hover:bg-slate-800'
            }`}
          >
            {copyStatus === 'copied' ? <CheckCircle className="w-4 h-4"/> : <LinkIcon className="w-4 h-4"/>}
            {copyStatus === 'copied' ? 'é“¾æ¥å·²å¤åˆ¶' : 'å¤åˆ¶ç»“æœé“¾æ¥'}
          </button>
          
          <button 
            onClick={handlePrint}
            className="flex items-center gap-2 px-5 py-3 rounded-full bg-white text-slate-700 border border-slate-200 font-bold hover:bg-slate-50 transition-all"
          >
            <Printer className="w-4 h-4" />
            ä¿å­˜æŠ¥å‘Š
          </button>

          {!isSharedView && (
             <button 
               onClick={startTest}
               className="p-3 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 transition-all"
               title="é‡æ–°æµ‹è¯•"
             >
               <RefreshCw className="w-5 h-5" />
             </button>
          )}
        </div>

        {/* Print Only Footer */}
        <div className="hidden print:block text-center text-xs text-gray-400 mt-8">
          æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š{new Date().toLocaleDateString()}
        </div>

      </div>
    </div>
  );
}
